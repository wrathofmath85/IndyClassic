<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Indy Classic — Courts</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#eaf8e6;          /* pale green background */
    --card:#ffdcd2;        /* light peach court cards */
    --ink:#20242a;         /* text */
    --muted:#4b5563;       /* muted text */
    --border:#cbd5e1;      /* soft border */
    --accent:#1f2937;      /* dark header ink */
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{max-width:1160px; margin:24px auto; padding:0 16px 64px}
  header{display:flex; align-items:end; justify-content:space-between; gap:12px; margin-bottom:16px}
  h1{margin:0; font-size:28px; font-weight:800; color:var(--accent)}
  .ts{font-size:12px; color:var(--muted)}
  .controls{display:flex; gap:8px; align-items:center}
  button{
    border:1px solid var(--border); background:#fff; color:var(--ink);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
  }
  button:hover{filter:brightness(0.98)}
  .grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(280px, 1fr));
    gap:28px 48px;
  }
  @media (max-width:800px){
    .grid{grid-template-columns: 1fr; gap:18px}
  }

  .court{
    background:var(--card); border:1px solid var(--border); border-radius:8px;
    min-height:120px; padding:10px 14px; position:relative;
    display:flex; flex-direction:column; justify-content:flex-start;
  }
  .court .title{
    text-align:center; font-weight:800; margin:2px 0 6px; font-size:16px;
  }
  .court .sub{
    text-align:center; color:var(--accent); font-weight:700; font-size:14px; margin-bottom:8px;
  }
  .court .line{height:1px; background:var(--border); margin:6px 0}
  .row{display:flex; justify-content:center; align-items:center; gap:6px; min-height:22px}
  .vs{font-size:12px; color:var(--muted)}
  .team{font-size:13px; text-align:center}
  .empty .team, .empty .sub{color:#9aa1b1}
  .footer{
    margin-top:28px; background:var(--card); border:1px solid var(--border);
    border-radius:8px; padding:12px 14px;
  }
  .footer h2{
    text-align:center; margin:4px 0 10px; font-size:16px; font-weight:800; color:var(--accent);
  }
  .up-list{margin:0; padding:0; list-style:none}
  .up-list li{
    display:flex; gap:8px; justify-content:center; align-items:center;
    padding:6px 4px; border-top:1px dashed var(--border); font-size:13px;
  }
  .up-list li:first-child{border-top:none}
  .err{color:#b42318; font-weight:700; text-align:center; margin-top:8px}
  .stamp{font-size:11px; color:var(--muted); text-align:center; margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Court Assignments</h1>
        <div class="ts" id="sourceNote">Loading CSV…</div>
      </div>
      <div class="controls">
        <button id="refreshBtn" title="Reload CSV">Refresh</button>
      </div>
    </header>

    <section class="grid" id="courtsGrid">
      <!-- 16 courts are injected here -->
    </section>

    <section class="footer">
      <h2>Upcoming Matches</h2>
      <ul class="up-list" id="upcomingList"></ul>
      <div class="stamp" id="lastUpdated"></div>
      <div class="err" id="errorMsg" hidden></div>
    </section>
  </div>

<script>
  // ====== CONFIG ======
  // Replace with your Google Sheet CSV export URL
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrbxnR_sR21PWkZNhsqpzlnaQJ7AXhWmUN0aA_r9nXIxsdfQ6OnFsBEf9_aeVCIpZPIjhBAA5KraS_/pub?gid=0&single=true&output=csv";

  // Number of courts and upcoming rows to show
  const NUM_COURTS = 16;
  const UPCOMING_COUNT = 10;

  // ====== DOM helpers ======
  const courtsGrid = document.getElementById('courtsGrid');
  const upList = document.getElementById('upcomingList');
  const lastUpdated = document.getElementById('lastUpdated');
  const errMsg = document.getElementById('errorMsg');
  const sourceNote = document.getElementById('sourceNote');
  const refreshBtn = document.getElementById('refreshBtn');

  // Build the court placeholders once
  function buildCourtShells(){
    courtsGrid.innerHTML = '';
    for(let i=1;i<=NUM_COURTS;i++){
      const card = document.createElement('article');
      card.className = 'court empty';
      card.dataset.court = i;

      card.innerHTML = `
        <div class="title">Court ${i}</div>
        <div class="sub" data-sub> </div>
        <div class="line"></div>
        <div class="row"><div class="team" data-team1> </div></div>
        <div class="row"><div class="vs">vs</div></div>
        <div class="row"><div class="team" data-team2> </div></div>
      `;
      courtsGrid.appendChild(card);
    }
  }

  // Robust trimming
  const tidy = v => (v==null ? '' : String(v).trim());

  // Treat empty / 0 / NA as "no court"
  function isCourtEmpty(v){
    const t = tidy(v);
    if (!t) return true;
    const low = t.toLowerCase();
    if (['na','n/a','none','null','-','—','0'].includes(low)) return true;
    return false;
  }

  // Parse US "Sun 6/23/2024 8:00 AM" safely
  function toDateOrNull(v){
    const s = tidy(v);
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }

  // Core: load + render
  async function loadCSV(){
    errMsg.hidden = true;
    sourceNote.textContent = 'Loading CSV…';

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      complete: (res) => {
        try{
          if (res.errors && res.errors.length){
            console.warn(res.errors);
          }
          renderFromRows(res.data);
          sourceNote.textContent = 'Source: Google Drive CSV';
        }catch(e){
          errMsg.hidden = false;
          errMsg.textContent = 'Error rendering data: ' + e.message;
        }
      },
      error: (e) => {
        errMsg.hidden = false;
        errMsg.textContent = 'CSV load failed: ' + e.message;
        sourceNote.textContent = 'Failed to load CSV';
      }
    });
  }

  function renderFromRows(rows){
    buildCourtShells();

    // Normalize rows to a predictable shape
    // Expecting headers: Time, Event, Round, Team 1, Team 2, Court
    const normalized = rows.map((r, idx) => {
      const obj = {
        _row: idx, // keep original order for "first 5 without court"
        timeRaw: tidy(r['Time']),
        time: toDateOrNull(r['Time']),
        event: tidy(r['Event']),
        round: tidy(r['Round']),
        team1: tidy(r['Team 1']),
        team2: tidy(r['Team 2']),
        courtRaw: tidy(r['Court'])
      };
      // try fallback header variants just in case
      if(!obj.team1 && tidy(r['Team1'])) obj.team1 = tidy(r['Team1']);
      if(!obj.team2 && tidy(r['Team2'])) obj.team2 = tidy(r['Team2']);
      if(!obj.courtRaw && tidy(r['Court #'])) obj.courtRaw = tidy(r['Court #']);

      // numeric court if possible
      const num = parseInt(obj.courtRaw, 10);
      obj.court = (!isCourtEmpty(obj.courtRaw) && !Number.isNaN(num)) ? num : null;

      return obj;
    });

    // ====== Fill most recent per court ======
    // group by court, pick entry with latest time (if same court appears multiple times)
    const latestByCourt = new Map();
    for(const r of normalized){
      if(r.court==null) continue;
      const key = r.court;
      const prev = latestByCourt.get(key);
      if(!prev){
        latestByCourt.set(key, r);
      }else{
        // choose the one with the most recent (max) time; if either missing time, prefer the one that *has* a time
        const tA = prev.time ? prev.time.getTime() : -Infinity;
        const tB = r.time ? r.time.getTime() : -Infinity;
        if (tB >= tA) latestByCourt.set(key, r);
      }
    }

    // write to DOM
    for(const [courtNum, row] of latestByCourt.entries()){
      if(courtNum < 1 || courtNum > NUM_COURTS) continue;
      const card = courtsGrid.querySelector(`.court[data-court="${courtNum}"]`);
      if(!card) continue;

      const sub = card.querySelector('[data-sub]');
      const t1  = card.querySelector('[data-team1]');
      const t2  = card.querySelector('[data-team2]');

      const subTxt = (row.event && row.round) ? `${row.event} - ${row.round}`
                    : (row.event || row.round || ' ');
      sub.textContent = subTxt;
      t1.textContent = row.team1 || ' ';
      t2.textContent = row.team2 || ' ';

      card.classList.remove('empty');
    }

    // ====== Upcoming (first 5 rows with NO court number, by original order) ======
    const upcoming = normalized.filter(r => r.court==null).slice(0, UPCOMING_COUNT);

    upList.innerHTML = '';
    if(upcoming.length === 0){
      upList.innerHTML = `<li>No upcoming matches listed.</li>`;
    }else{
      for(const r of upcoming){
        const li = document.createElement('li');
        const vs = `${r.team1 || '—'}  vs  ${r.team2 || '—'}`;
        li.textContent = vs;
        upList.appendChild(li);
      }
    }

    // stamp
    const now = new Date();
    lastUpdated.textContent = `Last updated: ${now.toLocaleString()}`;
  }

  // Initial load + manual refresh
  loadCSV();
  refreshBtn.addEventListener('click', loadCSV);

  // Optional: auto-refresh every 60s (toggle if you want)
  // setInterval(loadCSV, 60000);
</script>
</body>
</html>
